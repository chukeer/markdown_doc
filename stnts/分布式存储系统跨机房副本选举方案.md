# 分布式存储系统跨机房副本选举方案

分布式存储系统可以抽象为一个硬盘，但它会为每个文件存储多个副本，通过冗余的方式保证系统的可靠性

副本选举涉及三个场景

1. 文件写入
2. 副本复制
3. 副本迁移

若不考虑跨机房的问题，选举本身是很简单的逻辑，即只需在系统里选出N个节点存储副本，而这N个节点在系统中的角色的等价的，但如果考虑跨机房的问题，由于跨机房读写效率远远低于同机房读写，基于读写效率考虑，节点本身就会被附带上不同属性，因此也会让选举更加复杂。为了让分布式存储本身更加简单和可靠，我们从架构角度一层一层推进，选择最适合我们的选举方案

## 多个BitQiu系统

![多系统](http://littlewhite.us/pic/distributed-storage/multi-system.png)

我们在每个机房部署一套BitQiu系统，其中BGP机房为主系统，单线机房为备份系统，读写流程如下

1. 客户端写入文件到BGP机房，然后通过某种同步机制将数据异步同步到其它单线机房的BitQiu系统
2. 客户端从BGP机房读取文件，当BGP机房出故障时，客户端可以切换到单线机房去读取，但是不能写入

即每个单线机房的BitQiu作为BGP机房的一个完整备份（由于同步数据需要时间，数据会有一定延时），这样每个BitQiu系统都部署在同机房内，不存在跨机房的问题，系统内部的选举和写入都会非常简单且高效，至于数据同步，可以使用单独的设施去实现，这样BitQiu只用去关注存储系统的核心功能，但也有如下缺点

* 部署和维护比较麻烦，需要维护多套BitQiu系统
* 若有多个单线机房，需要在每个的单线机房都部署BitQiu系统，且每个机房都会有副本产生

## 主备副本

为了解决以上方案的缺陷，我们仍旧只采用一个BitQiu系统，但在系统内部会根据机房情况划分主备副本，这样可以抽象成多个BitQiu系统，只是它们共享RootServer

![主备](http://littlewhite.us/pic/distributed-storage/zhu-bei.png)

所有BGP机房组成主机房，所有单线机房组成备机房，读写流程如下

1. 客户端写入文件，选择最近一个BGP机房，联通电信各选一个副本，如果需求副本数大于2，则从备机房选取其它副本，客户端将副本写入主机房，由主机房节点推送到备机房
2. 客户端读取直接从主机房读取，如果主机房节点下线，则从备机房读取

这样主机房将拥有文件系统的所有文件副本，如果副本数大于2，备机房也拥有所有副本。这里的主机房和备机房类似于前面的BitQiu系统，同理，所有写入都由主机房写入，读取则就近读取

## 副本指定机房

对于某些特殊需求，可能需要指定副本所在的机房，这时在选举时会优先选择指定机房，再选择主机房，数据仍旧由主机房写入，推送到备机房，如下

![指定机房](http://littlewhite.us/pic/distributed-storage/zhiding-jifang.png)

这时主机房的节点会根据副本需求选择是否作为bridge角色，当作为bridge角色时，只负责副本转发而不存储副本，在做跨机房副本转发时，只可能是联通向联通节点转发，电信向电信转发

* 如果指定机房为BGP机房，在该机房选择联通电信各一个副本，其它副本在备机房选择
* 如果指定机房为备机房，假设指定电信机房，数量为1，那么先在BGP机房选择一对联通电信节点，若需求的电信副本数等于1，则BGP机房的电信节点作为bridge，否则作为普通节点，指定的联通机房也按同样方式处理，对于其它副本则按照正常选举

所有写入仍旧从主机房写入，由主机房推送到备机房

### 副本复制

1. 选举指定机房副本
2. 若副本数不够，且主机房副本数不足2，则在主机房选举副本
3. 若副本数不够，在其它备机房选举副本
4. 所有选举出来的副本，通过算法选择最优的方式从现有副本进行复制

举例

1. 主机房有两个副本，备机房缺少一个副本  
	从备机房选择一个副本，从主机房同步

2. 主机房有一个副本，且缺少一个副本  
	从主机房选择另一个副本，从本机房同步

3. 主机房没有副本，备机房缺少一个指定副本  
	从指定机房选取一个副本  
	从主机房选取电信联通各一个节点，作为bridge  
	指定机房副本通过主机房的bridge节点从其它备机房进行同步  

### 副本迁移
考虑两种迁移方案

1. 只在机房内部迁移，即单线机房或BGP机房内部进行迁移，不会跨机房
2. 主机房副本只在各机房内部迁移，备机房副本可以在备机房间跨机房迁移