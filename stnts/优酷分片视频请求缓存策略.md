#优酷分片视频请求缓存策略
优酷的视频在服务器上是以完整的视频文件存在，但在客户端请求时并非一次请求一个完整文件，而是每次请求一个分片，这样的好处也显而易见，当用户快进时可以通过计算视频偏移迅速请求分片。但由于每次请求的分片偏移不是固定的，就导致即便在看了一遍视频，缓存所有分片后，再播放视频进行分片请求时，可能一次都不会命中，这里提供一种通过链接转化的方式，可以大大提高缓存命中率

##优酷分片链接
以播放页[http://v.youku.com/v_show/id_XMTQ3OTM4NDc0OA==.html?f=23710673](http://v.youku.com/v_show/id_XMTQ3OTM4NDc0OA==.html?f=23710673)为例

**PS:优酷的视频可能有不同的形式，这里只分析下面的这种特点的链接，另外一种是带有`start=`参数的**

该播放页的视频请求链接有两种

1. http://183.60.145.233/youku/69770EC06723C7F61F078279D/<font color="red">030008020056CB4D74F84B07BD037BA1882A80-4763-9527-E125-BD2377B90C23.mp4</font>?nk=85518226221_24280195376&ns=2_12&special=true

2. http://183.60.145.233/youku/69770EC06723C7F61F078279D/<font color="red">030008020056CB4D74F84B07BD037BA1882A80-4763-9527-E125-BD2377B90C23.mp4</font>?nk=85518226225_24280195391&ns=<font color="red">71730</font>_2<font color="red">1434600</font>&special=true

其中重要信息已经用红色标记，这两个链接对应的完整文件链接为
http://183.60.145.233/youku/69770EC06723C7F61F078279D/030008020056CB4D74F84B07BD037BA1882A80-4763-9527-E125-BD2377B90C23.mp4

第一种链接请求的是视频文件头，在第一次请求某个完整文件的分片时会先请求该链接。第二种链接请求的是完整文件对应的分片，ns后面标红的参数分别代表offset和size

##链接转换
第一种链接当普通链接处理即可，分片请求链接主要是第二种。该链接包含了视频完整文件的地址和请求的偏移信息，服务器对分片信息进行处理，直接返回请求的分片内容，这里我们将其转化成标准http请求方式，通过http包头的Range字段标记请求偏移，以curl作为http客户端，以下两种方式返回的文件内容是一样的

    1. curl 'http://183.60.145.233/youku/69770EC06723C7F61F078279D/030008020056CB4D74F84B07BD037BA1882A80-4763-9527-E125-BD2377B90C23.mp4?nk=85518226225_24280195391&ns=71730_21434600&special=true'
    2. curl -H "Range:bytes=71730-1506329" 'http://183.60.145.233/youku/69770EC06723C7F61F078279D/030008020056CB4D74F84B07BD037BA1882A80-4763-9527-E125-BD2377B90C23.mp4'
    
##链接转化策略
由以上分析可知，对于优酷的分片视频请求，我们只需要提取出完整文件请求，以及对应的请求Range信息即可通过标准http请求获取分片信息，基于此，当客户端进行分片请求时，缓存流程如下

![](http://192.168.3.55/RedCoast/pic/%E4%BC%98%E9%85%B7%E5%88%86%E7%89%87%E8%A7%86%E9%A2%91%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98%E8%BF%87%E7%A8%8B.png)

说明

1. 第一次请求  
    1.1 请求文件的分片信息  
    1.2 转换链接后，向原始服务器请求  
    1.3 当请求的分片从服务器请求回来后即返回给客户端  
    1.4 和1.3步骤并行，缓存完整文件
2. 第二次请求  
    2.1 请求文件的分片信息  
    2.2 由于之前已经缓存文件（可能完整文件还没缓存完成，但索引已经建立，因此会认为命中缓存），直接从缓存获取分片内容（若请求的分片信息还没缓存，会等待缓存到了该分片内容后再读取）  
    2.3 将分片信息返回给客户端，并标记为命中缓存
3. 其它请求...

squid支持对带Range请求的缓存，因此以上的缓存完整文件和从文件中读取分片信息的步骤由squid原生支持，只需要对链接进行转换即可，并且转换之后的链接仍要进行归一化处理

##优化
以上方式存在一种问题

假设完整文件长度为10M，客户端第一次请求Range为9M到10M，如果采用优酷原有的链接，服务器会直接返回9M到10M的内容，如果进行链接转化，采用标准http协议，由于第一次不会命中缓存，squid会等到原始服务器返回前9M内容后才开始向客户端返回数据，这是因为squid需要对完整文件进行缓存导致的

在看连戏剧时，视频网站往往会直接跳过片头，这时第一次请求的偏移可能从文件中间开始，如果按上面的策略，客户端会显得卡顿一下，可以采用如下优化策略

>在每次进行链接转换之后，如果该链接未命中缓存且请求偏移大于某阈值（比如2M），则采用原始链接进行请求

##总结
以上方案可解决，当第一次顺序观看完视频后，第二次不管如何快进，所有请求均可命中缓存，对于现实场景应该能满足大部分需求。当然也有其局限性，若第一次观看时并不是顺序观看，可能并不会缓存所有完整文件