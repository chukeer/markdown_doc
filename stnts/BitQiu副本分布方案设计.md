# BitQiu副本分布设计方案
### 当前分布情况
BitQiu目前一共有4各机房分别是武汉电信、武汉联通、扬州电信、承德联通

其中武汉电信和联通为直连机房，从逻辑上可看作一个机房

通过对BitQiu所有文件副本进行统计，得到如下数据

统计时间 2016-08-08

page数量 | 百分比 | 副本数 | 机房分布
:--- | :--- | :--- | :---
6774033 | 92.191096% | 4 | 武汉电信x1 武汉联通x1 扬州电信x1 承德联通x1
402189 | 5.473585% | 4 | 武汉电信x1 扬州电信x1 承德联通x2
39303 | 0.534894% | 4 | 武汉电信x1 武汉联通x1
31716 | 0.431638% | 4 | 武汉电信x1
23677 | 0.322232% | 5 | 武汉电信x1 武汉联通x1 扬州电信x1 承德联通x2
16807 | 0.228735% | 4 | 武汉电信x2 武汉联通x1 承德联通x1
13151 | 0.178978% | 5 | 武汉电信x1 武汉联通x2 扬州电信x1 承德联通x1
12362 | 0.168240% | 4 | 武汉电信x1 武汉联通x2 扬州电信x1
9481 | 0.129032% | 6 | 武汉电信x1 武汉联通x2 扬州电信x2 承德联通x1
6172 | 0.083998% | 5 | 武汉电信x3 武汉联通x1 承德联通x1
6075 | 0.082678% | 5 | 武汉电信x2 武汉联通x2 扬州电信x1
5782 | 0.078690% | 6 | 武汉电信x1 武汉联通x2 扬州电信x1 承德联通x2
1955 | 0.026607% | 5 | 武汉电信x3 武汉联通x2
1651 | 0.022469% | 6 | 武汉电信x2 武汉联通x2 扬州电信x1 承德联通x1
863 | 0.011745% | 4 | 武汉电信x2 承德联通x2
628 | 0.008547% | 7 | 武汉电信x2 武汉联通x2 扬州电信x1 承德联通x2
509 | 0.006927% | 6 | 武汉电信x1 武汉联通x1 扬州电信x2 承德联通x2
291 | 0.003960% | 1 | 扬州电信x1
275 | 0.003743% | 5 | 武汉电信x2 武汉联通x1 扬州电信x1 承德联通x1
192 | 0.002613% | 5 | 武汉电信x3 承德联通x2
128 | 0.001742% | 1 | 武汉电信x1
126 | 0.001715% | 5 | 武汉电信x2 武汉联通x1 承德联通x2
95 | 0.001293% | 4 | 武汉电信x2 武汉联通x2
68 | 0.000925% | 4 | 武汉电信x1 扬州电信x2 承德联通x1
64 | 0.000871% | 4 | 武汉电信x3 承德联通x1
50 | 0.000680% | 6 | 武汉电信x2 武汉联通x1 扬州电信x1 承德联通x2
22 | 0.000299% | 6 | 武汉电信x3 武汉联通x2 承德联通x1
20 | 0.000272% | 3 | 武汉电信x1 武汉联通x1 扬州电信x1
20 | 0.000272% | 5 | 武汉电信x1 扬州电信x2 承德联通x2
15 | 0.000204% | 1 | 承德联通x1
14 | 0.000191% | 5 | 武汉电信x2 武汉联通x3
13 | 0.000177% | 2 | 武汉联通x1 扬州电信x1
12 | 0.000163% | 2 | 武汉电信x1 武汉联通x1
11 | 0.000150% | 9 | 武汉电信x1 武汉联通x3 扬州电信x2 承德联通x3
9 | 0.000122% | 6 | 武汉电信x1 武汉联通x1 扬州电信x1 承德联通x3
9 | 0.000122% | 4 | 武汉电信x3 武汉联通x1
9 | 0.000122% | 1 | 
7 | 0.000095% | 8 | 武汉电信x1 武汉联通x3 扬州电信x2 承德联通x2
4 | 0.000054% | 5 | 武汉电信x2 武汉联通x2 承德联通x1
3 | 0.000041% | 4 | 武汉联通x1 扬州电信x2 承德联通x1
1 | 0.000014% | 7 | 武汉电信x1 武汉联通x2 扬州电信x1 承德联通x3
1 | 0.000014% | 5 | 武汉电信x1 武汉联通x3 扬州电信x1
1 | 0.000014% | 7 | 武汉电信x1 武汉联通x1 扬州电信x2 承德联通x3
1 | 0.000014% | 8 | 武汉电信x1 武汉联通x2 扬州电信x2 承德联通x3
1 | 0.000014% | 6 | 武汉电信x2 武汉联通x2 承德联通x2
1 | 0.000014% | 6 | 武汉电信x3 武汉联通x1 承德联通x2

### CAP理论的体现
分布式系统需满足CAP理论，BitQiu副本复制采用异步方式，牺牲了一致性，为最终一致性，不满足C（一致性），因此系统必须满足A（可用性）和P（分区容忍性），当写入最小副本为N时，为了满足A，必须全部写本地机房，因为此时写入对于N副本来说为强一致性，必须全部写完才返回成功，如果发生跨机房写入，且机房间网络故障，将导致写入不可用，P体现在当有机房出现故障时仍旧能提供服务，因此副本的分布必须跨机房，否则如果都在一个机房且该机房故障，将无法提供读服务

因此BitQiu目前对CAP的支持是AP without C，下面所有设计方案都将遵循这种状态

### 副本整理
基于以上理论，副本整理方案设计如下

1. 若副本数小于3，不做整理
2. 若副本数等于3，整理后副本分布为一个武汉联通，一个武汉电信，一个扬州电信
3. 若副本数等于4，整理后副本分布为一个武汉联通，一个武汉电信，一个扬州电信，一个承德联通
4. 若副本数大于4，整理后副本分布为一个武汉联通，一个武汉电信，一个扬州电信，一个承德联通，剩余N副本，电信为(N+1)/2，联通为N-(N+1)/2，根据机房负载选择，优先选择负载小的机房

### 副本写入
为了满足可用性，副本写入全部写本地机房，根据BitQiu现在的机房分布情况，写入策略如下

1. 客户端不在任何一个机房，此时系统将丢失可用性，不推荐这种部署方案，也不会为其做优化。根据机房负载，所有副本写入负载最低的一个机房
2. 客户端在武汉机房，此时所有副本写入武汉机房，假设副本数为N，则电信副本(N+1)/2，联通副本N-(N+1)/2
3. 客户端在扬州电信机房，此时全部写电信副本
4. 客户端在承德联通机房，此时全部写联通副本
5. 副本异步复制，假设需要复制N副本，优先写入没有副本的机房，若总副本数大于机房数，则多出的副本按照机房负载选择负载低的机房写入
6. 待复制完成后，按照副本整理方案进行副本整理，保证每个机房副本数之差不大于1

如果对可用性要求苛刻，直连机房也应该当作不同机房，写入时只将副本写入相同的物理机房，即武汉联通的客户端写入时只写武汉联通机房，而不会写直连的武汉电信机房

### 副本指定机房
指定机房只影响副本整理，不影响副本写入，也就是说在写入时所有副本都写本机房，再通过副本整理达到指定机房的状态，仍旧是最终一致性。如果写入时就指定机房，会发生跨机房的问题，此时系统的可用性无法得到保障。这样设计的前提是，如果系统在CAP理论中满足的是AP without C，那么系统在运转过程中不会因为其它外部因素转化为CA without P或CP without A